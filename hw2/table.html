<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<body>
<style>
    table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
        border: 2px solid gray;
    }
    thead th,
    tfoot th {
        font-family: bold;
    }
    th {
        letter-spacing: 2px;
    }
    td {
        letter-spacing: 1px;
    }
    tbody td {
        text-align: center;
    }
    tfoot th {
        text-align: right;
    }
    table td {
        border: 1px solid black;
    }
    table th {
        border: 1px solid black;
        height: 35px;
        font-family: sans-serif;
        font-weight: 700;
    }
    img {
        position: relative;
        left: 3px;
        height: 10px;
        top: 1px;
        width: 12px;
        cursor: pointer
    }
</style>

<label>Time update:</label>
<span class="min-year-value"></span>
<input class="range-selector" type="range" name="points" step="1" value="0" id="slider-time" oninput=";">
<span class="max-year-value"></span>
<br>
<label>Filter by:</label>
<input type="checkbox" class="myCheckbox" value="Americas"> Americas
<input type="checkbox" class="myCheckbox" value="Africa"> Africa
<input type="checkbox" class="myCheckbox" value="Asia"> Asia
<input type="checkbox" class="myCheckbox" value="Europe"> Europe
<input type="checkbox" class="myCheckbox" value="Oceania"> Oceania

<br>
<label>Encode Bars By:</label>
<label>Population<input checked="true" class="bars-encode-selector" name="bars-encode" type="radio"  value="population" onclick=""></label>
<label>GDP<input  class="bars-encode-selector" name="bars-encode" type="radio"  value="gdp" onclick=""></label>

<br>
<label>Aggregation By:</label>
<label>Country<input class="agg-selector" checked='true' type="radio" name="agg" value="none" onclick=""></label>
<label>Continent<input  class="agg-selector" type="radio" name="agg" value="byCont" onclick=""></label>


<br>
<label>Sort By:</label>
<label>Name<input class="sort-selector" checked='true' name="sorts" type="radio"  value="name" onclick=""></label>
<label>Population<input  class="sort-selector" name="sorts" type="radio"  value="population" onclick=""></label>
<label>GDP<input  class="sort-selector" name="sorts" type="radio"  value="gdp" onclick=""></label>

<br>

<label>View type:</label>
<label>Table<input class="view-selector" checked='true' name="view" type="radio"  value="table" onclick=""></label>
<label>Graph<input  class="view-selector" name="view" type="radio"  value="graph" onclick=""></label>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
    var cnt = 0;
    var curr_header = '';

    var sortAscending = true;

    var life_exp = d3.format (".1f");
    var pop = d3.format (",.2r");
    var g_d_p = d3.format (".3s");

    var max_year,min_year;


    d3.json('countries_1995_2012.json', function (errorYears, years_data) {
        d3.json("countries_2012.json", function (error, data) {
            for (var i in data){
                delete data[i]["alpha2_code"];
                delete data[i]["latitude"];
                delete data[i]["longitude"];
                data[i].life_expectancy = life_exp(data[i].life_expectancy);
                data[i].population = pop(data[i].population);
                data[i].gdp = g_d_p(data[i].gdp);
            }

            new_data = []
            for (var i in data){
                obj = {
                    'name':data[i].name,
                    'continent':data[i].continent,
                    'gdp':data[i].gdp,
                    'life_expectancy':data[i].life_expectancy,
                    'year':data[i].year
                }
                new_data.push(obj);
            }

            data = new_data;

            // ultra HARD year finder
            years_data.forEach(function (countryModel) {
                countryModel.years.forEach(function (model) {
                    if (model.year > max_year || !max_year) {
                        max_year = model.year;
                    }

                    if (model.year < min_year || !min_year) {
                        min_year = model.year;
                    }
                })
            }, this);


            d3.select('.range-selector')
                .attr('min', min_year)
                .attr('value', min_year)
                .attr('max', max_year);


            d3.select('.max-year-value')
                .text(max_year);


            d3.select('.min-year-value')
                .text(min_year);


            var columns = Object.keys(data[0]);


            var table = d3.select("body").append("table"),
                thead = table.append("thead")
                    .attr("class", "thead");
            tbody = table.append("tbody");


            table.append("caption")
                .html("World Countries Ranking");


            var choices = [];
            d3.selectAll(".myCheckbox").each(function (d) {
                var cb = d3.select(this);
                if (cb.property("checked")) {
                    choices.push(cb.property("value"));
                }
            });

            if (choices.length == 0) {
                choices = ['Americas', 'Africa', 'Asia', 'Europe', 'Oceania'];
            }

            var filteredData = data.filter(function (model) {
                return choices.indexOf(model.continent) != -1
            })
            var resultData = filteredData;


            thead.append("tr").selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                .text(function (d) {
                    return d;
                })
                .on("click", function (header, i) {

                    d3.select("img").remove();

                    if (sortAscending) {
                        sortAscending = false;
                        d3.select(this).append('img').attr('src', '2.png');
                        d3.select(this).style("cursor", "n-resize");
                        tbody.selectAll("tr").sort(function (a, b) {
                            return d3.descending(a[header], b[header]);
                        }).style("background-color", function (d, i) {
                            if (i % 2 == 1) {
                                return "#D8D8D8";
                            }
                            else {
                                return "#ffffff";
                            }
                        });
                    }
                    else {
                        sortAscending = true;
                        d3.select(this).append('img').attr('src', '1.png');
                        tbody.selectAll("tr").sort(function (a, b) {
                            return d3.ascending(a[header], b[header]);
                        }).style("background-color", function (d, i) {
                            if (i % 2 == 1) {
                                return "#D8D8D8";
                            }
                            else {
                                return "#ffffff";
                            }
                        });
                    }
                });



            var rows = tbody.selectAll("tr.row")
                .data(data)
                .enter()
                .append("tr").attr("class", "row")
                .style("background-color", function (d, i) {
                    if (i % 2 == 1) {
                        return "#D8D8D8";
                    }
                });


            var cells = rows.selectAll("td")
                .data(function (row) {
                    return d3.range(Object.keys(row).length).map(function (column, i) {
                        return row[Object.keys(row)[i]];
                    });
                })
                .enter()
                .append("td")
                .text(function (d) {
                    return d;
                })

                .on("mouseover", function (d, i) {

                    d3.select(this.parentNode)
                        .style("background-color", "#F3ED86");

                })
                .on("mouseout", function () {

                    tbody.selectAll("tr").style("background-color", function (d, i) {
                        if (i % 2 == 1) {
                            return "#D8D8D8";
                        }
                        else {
                            return "#ffffff";
                        }
                    });

                });

        });
    });
</script>
</body>
</html>